<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>c-icap-doc: services/echo/srv_echo.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>services/echo/srv_echo.c</h1><p>The srv_echo.c is an example service implementation, which does not modifies the content</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> *  Copyright (C) 2004-2008 Christos Tsantilas</span>
<span class="comment"> *</span>
<span class="comment"> *  This program is free software; you can redistribute it and/or</span>
<span class="comment"> *  modify it under the terms of the GNU Lesser General Public</span>
<span class="comment"> *  License as published by the Free Software Foundation; either</span>
<span class="comment"> *  version 2.1 of the License, or (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> *  This program is distributed in the hope that it will be useful,</span>
<span class="comment"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="comment"> *  Lesser General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> *  You should have received a copy of the GNU Lesser General Public</span>
<span class="comment"> *  License along with this library; if not, write to the Free Software</span>
<span class="comment"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,</span>
<span class="comment"> *  MA  02110-1301  USA.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &quot;common.h&quot;</span>
<span class="preprocessor">#include &quot;c-icap.h&quot;</span>
<span class="preprocessor">#include &quot;service.h&quot;</span>
<span class="preprocessor">#include &quot;header.h&quot;</span>
<span class="preprocessor">#include &quot;body.h&quot;</span>
<span class="preprocessor">#include &quot;simple_api.h&quot;</span>
<span class="preprocessor">#include &quot;debug.h&quot;</span>
<span class="comment">//add by jgong</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="comment">//#include &quot;http_parser.h&quot;</span>


<span class="keywordtype">int</span> echo_init_service(<a class="code" href="group__SERVICES.html#ga033e7bb0a88b3619abbc17230ad98eb4" title="Stores required data and settings for a service.">ci_service_xdata_t</a> * srv_xdata,
                      <span class="keyword">struct</span> <a name="_a0"></a><a class="code" href="structci__server__conf.html" title="This struct holds the basic configurations of c-icap server.">ci_server_conf</a> *server_conf);
<span class="keywordtype">int</span> echo_check_preview_handler(<span class="keywordtype">char</span> *preview_data, <span class="keywordtype">int</span> preview_data_len,
                               <a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> *);
<span class="keywordtype">int</span> echo_end_of_data_handler(<a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req);
<span class="keywordtype">void</span> *echo_init_request_data(<a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req);
<span class="keywordtype">void</span> echo_close_service();
<span class="keywordtype">void</span> echo_release_request_data(<span class="keywordtype">void</span> *data);
<span class="keywordtype">int</span> echo_io(<span class="keywordtype">char</span> *wbuf, <span class="keywordtype">int</span> *wlen, <span class="keywordtype">char</span> *rbuf, <span class="keywordtype">int</span> *rlen, <span class="keywordtype">int</span> iseof,
            <a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req);


CI_DECLARE_MOD_DATA <a name="_a1"></a><a class="code" href="structci__service__module.html" title="Is the structure which implements a service.">ci_service_module_t</a> service = {
     <span class="stringliteral">&quot;echo&quot;</span>,                         <span class="comment">/* mod_name, The module name */</span>
     <span class="stringliteral">&quot;Echo demo service&quot;</span>,            <span class="comment">/* mod_short_descr,  Module short description */</span>
     ICAP_RESPMOD | ICAP_REQMOD,     <span class="comment">/* mod_type, The service type is responce or request modification */</span>
     echo_init_service,              <span class="comment">/* mod_init_service. Service initialization */</span>
     NULL,                           <span class="comment">/* post_init_service. Service initialization after c-icap </span>
<span class="comment">                                        configured. Not used here */</span>
     echo_close_service,           <span class="comment">/* mod_close_service. Called when service shutdowns. */</span>
     echo_init_request_data,         <span class="comment">/* mod_init_request_data */</span>
     echo_release_request_data,      <span class="comment">/* mod_release_request_data */</span>
     echo_check_preview_handler,     <span class="comment">/* mod_check_preview_handler */</span>
     echo_end_of_data_handler,       <span class="comment">/* mod_end_of_data_handler */</span>
     echo_io,                        <span class="comment">/* mod_service_io */</span>
     NULL,
     NULL
};

<span class="comment">/*</span>
<span class="comment">  The echo_req_data structure will store the data required to serve an ICAP request.</span>
<span class="comment">*/</span>
<span class="keyword">struct </span>echo_req_data {
    <span class="comment">/*the body data*/</span>
    ci_ring_buf_t *body;
    <span class="comment">/*flag for marking the eof*/</span>
    <span class="keywordtype">int</span> eof;
};

<span class="comment">/*</span>
<span class="comment"> * http_parser Callback</span>
<span class="comment"> */</span>

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span><span class="keywordtype">int</span> on_message_begin(http_parser* _) {
  (void)_;
  printf(<span class="stringliteral">&quot;\n***MESSAGE BEGIN***\n\n&quot;</span>);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_headers_complete(http_parser* _) {
  (void)_;
  printf(<span class="stringliteral">&quot;\n***HEADERS COMPLETE***\n\n&quot;</span>);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_message_complete(http_parser* _) {
  (void)_;
  printf(<span class="stringliteral">&quot;\n***MESSAGE COMPLETE***\n\n&quot;</span>);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_url(http_parser* _, <span class="keyword">const</span> <span class="keywordtype">char</span>* at, <span class="keywordtype">size_t</span> length) {
  (void)_;
  printf(<span class="stringliteral">&quot;Url: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)length, at);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_header_field(http_parser* _, <span class="keyword">const</span> <span class="keywordtype">char</span>* at, <span class="keywordtype">size_t</span> length) {
  (void)_;
  printf(<span class="stringliteral">&quot;Header field: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)length, at);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_header_value(http_parser* _, <span class="keyword">const</span> <span class="keywordtype">char</span>* at, <span class="keywordtype">size_t</span> length) {
  (void)_;
  printf(<span class="stringliteral">&quot;Header value: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)length, at);
  <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> on_body(http_parser* _, <span class="keyword">const</span> <span class="keywordtype">char</span>* at, <span class="keywordtype">size_t</span> length) {
  (void)_;
  printf(<span class="stringliteral">&quot;Body: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)length, at);
  <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/* This function will be called when the service loaded  */</span>
<span class="keywordtype">int</span> echo_init_service(<a class="code" href="group__SERVICES.html#ga033e7bb0a88b3619abbc17230ad98eb4" title="Stores required data and settings for a service.">ci_service_xdata_t</a> * srv_xdata,
                      <span class="keyword">struct</span> <a class="code" href="structci__server__conf.html" title="This struct holds the basic configurations of c-icap server.">ci_server_conf</a> *server_conf)
{
     ci_debug_printf(5, <span class="stringliteral">&quot;Initialization of echo module......\n&quot;</span>);
     
     <span class="comment">/*Tell to the icap clients that we can support up to 1024 size of preview data*/</span>
     <a name="a2"></a><a class="code" href="group__SERVICES.html#ga4baea98d2181bfa07189e048a889542a" title="Sets the maximum preview size supported by this service.">ci_service_set_preview</a>(srv_xdata, 1024);

     <span class="comment">/*Tell to the icap clients that we support 204 responses*/</span>
     <a name="a3"></a><a class="code" href="group__SERVICES.html#gafbb687c7869176c56b9217a61f400a9c" title="Enable the allow 204 responses for this service.">ci_service_enable_204</a>(srv_xdata);

     <span class="comment">/*Tell to the icap clients to send preview data for all files*/</span>
     <a name="a4"></a><a class="code" href="group__SERVICES.html#gafc50c2c4ef2c9d96c7f8d6c2f2bf5d2f" title="Set the list of file extensions that should previewed by the service.">ci_service_set_transfer_preview</a>(srv_xdata, <span class="stringliteral">&quot;*&quot;</span>);

     <span class="comment">/*Tell to the icap clients that we want the X-Authenticated-User and X-Authenticated-Groups headers</span>
<span class="comment">       which contains the username and the groups in which belongs.  */</span>
     <a name="a5"></a><a class="code" href="group__SERVICES.html#ga7da5b123d299b8b91930fe5eb669e254" title="Sets the service x-headers mask which defines the X-Headers supported by the service...">ci_service_set_xopts</a>(srv_xdata,  CI_XAUTHENTICATEDUSER|CI_XAUTHENTICATEDGROUPS);
     
     <span class="keywordflow">return</span> CI_OK;
}

<span class="comment">/* This function will be called when the service shutdown */</span>
<span class="keywordtype">void</span> echo_close_service() 
{
    ci_debug_printf(5,<span class="stringliteral">&quot;Service shutdown!\n&quot;</span>);
    <span class="comment">/*Nothing to do*/</span>
}

<span class="comment">/*This function will be executed when a new request for echo service arrives. This function will</span>
<span class="comment">  initialize the required structures and data to serve the request.</span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> *echo_init_request_data(<a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req)
{
    <span class="keyword">struct </span>echo_req_data *echo_data;

    <span class="comment">/*Allocate memory fot the echo_data*/</span>
    echo_data = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> echo_req_data));
    <span class="keywordflow">if</span> (!echo_data) {
        ci_debug_printf(1, <span class="stringliteral">&quot;Memory allocation failed inside echo_init_request_data!\n&quot;</span>);
        <span class="keywordflow">return</span> NULL;
    }

    <span class="comment">/*If the ICAP request encuspulates a HTTP objects which contains body data </span>
<span class="comment">      and not only headers allocate a ci_cached_file_t object to store the body data.</span>
<span class="comment">     */</span>
     <span class="keywordflow">if</span> (<a name="a6"></a><a class="code" href="group__REQUEST.html#ga880e2efbfecb44754d9eca657a2fc63c">ci_req_hasbody</a>(req))
          echo_data-&gt;body = ci_ring_buf_new(4096);
     <span class="keywordflow">else</span>
         echo_data-&gt;body = NULL;

     echo_data-&gt;eof = 0;
     <span class="comment">/*Return to the c-icap server the allocated data*/</span>
     <span class="keywordflow">return</span> echo_data;
}

<span class="comment">/*This function will be executed after the request served to release allocated data*/</span>
<span class="keywordtype">void</span> echo_release_request_data(<span class="keywordtype">void</span> *data)
{
    <span class="comment">/*The data points to the echo_req_data struct we allocated in function echo_init_service */</span>
    <span class="keyword">struct </span>echo_req_data *echo_data = (<span class="keyword">struct </span>echo_req_data *)data;
    
    <span class="comment">/*if we had body data, release the related allocated data*/</span>
    <span class="keywordflow">if</span>(echo_data-&gt;body)
        ci_ring_buf_destroy(echo_data-&gt;body);

    free(echo_data);
}


<span class="keyword">static</span> <span class="keywordtype">int</span> whattodo = 0;
<span class="keywordtype">int</span> echo_check_preview_handler(<span class="keywordtype">char</span> *preview_data, <span class="keywordtype">int</span> preview_data_len,
                               <a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req)
{
     ci_off_t content_len;
     
     <span class="comment">/*Get the echo_req_data we allocated using the  echo_init_service  function*/</span>
     <span class="keyword">struct </span>echo_req_data *echo_data = ci_service_data(req);

     <span class="comment">/*If there are is a Content-Length header in encupsulated Http object read it</span>
<span class="comment">      and display a debug message (used here only for debuging purposes)*/</span>
     content_len = <a name="a7"></a><a class="code" href="group__HTTP.html#gad381fe7908af08f1543c858d24cfbfdf" title="Returns the value of the Content-Length header of the HTTP response or HTTP request...">ci_http_content_length</a>(req);
     ci_debug_printf(9, <span class="stringliteral">&quot;We expect to read :%&quot;</span> PRINTF_OFF_T <span class="stringliteral">&quot; body data\n&quot;</span>,
                     (CAST_OFF_T) content_len);

     <span class="comment">/*If there are not body data in HTTP encapsulated object but only headers</span>
<span class="comment">       respond with Allow204 (no modification required) and terminate here the</span>
<span class="comment">       ICAP transaction */</span>
     <span class="keywordflow">if</span>(!<a class="code" href="group__REQUEST.html#ga880e2efbfecb44754d9eca657a2fc63c">ci_req_hasbody</a>(req))
         <span class="keywordflow">return</span> CI_MOD_ALLOW204;

     <span class="comment">/*Unlock the request body data so the c-icap server can send data before </span>
<span class="comment">       all body data has received */</span>
     <a name="a8"></a><a class="code" href="group__REQUEST.html#ga7d6685cf10deb060690da7f17020634e" title="Unlock a ci_request_t object.">ci_req_unlock_data</a>(req);

     <span class="comment">/*If there are not preview data tell to the client to continue sending data </span>
<span class="comment">       (http object modification required). */</span>
     <span class="keywordflow">if</span> (!preview_data_len)
          <span class="keywordflow">return</span> CI_MOD_CONTINUE;

     <span class="comment">/* In most real world services we should decide here if we must modify/process</span>
<span class="comment">        or not the encupsulated HTTP object and return CI_MOD_CONTINUE or  </span>
<span class="comment">        CI_MOD_ALLOW204 respectively. The decision can be taken examining the http</span>
<span class="comment">        object headers or/and the preview_data buffer.</span>
<span class="comment"></span>
<span class="comment">        In this example service we just use the whattodo static variable to decide</span>
<span class="comment">        if we want to process or not the HTTP object.</span>
<span class="comment">      */</span>
     <span class="keywordflow">if</span> (whattodo == 0) {
          whattodo = 1;
          ci_debug_printf(8, <span class="stringliteral">&quot;Echo service will process the request\n&quot;</span>);

          <span class="comment">/*if we have preview data and we want to proceed with the request processing</span>
<span class="comment">            we should store the preview data. There are cases where all the body</span>
<span class="comment">            data of the encapsulated HTTP object included in preview data. Someone can use</span>
<span class="comment">            the ci_req_hasalldata macro to  identify these cases*/</span>
          <span class="keywordflow">if</span> (preview_data_len) {

              ci_ring_buf_write(echo_data-&gt;body, preview_data, preview_data_len);

<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>              <span class="keyword">enum</span> http_parser_type file_type;
              file_type = HTTP_REQUEST;

              http_parser_settings settings;
              memset(&amp;settings, 0, <span class="keyword">sizeof</span>(settings));
              settings.on_message_begin = on_message_begin;
              settings.on_url = on_url;
              settings.on_header_field = on_header_field;
              settings.on_header_value = on_header_value;
              settings.on_headers_complete = on_headers_complete;
              settings.on_body = on_body;
              settings.on_message_complete = on_message_complete;

              http_parser parser;
              http_parser_init(&amp;parser, file_type);
              <span class="keywordtype">size_t</span> nparsed = http_parser_execute(&amp;parser, &amp;settings, preview_data, strlen(preview_data));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
              FILE *fp;
              fp = fopen(<span class="stringliteral">&quot;/home/jaygong/test/echo_service.log&quot;</span>, <span class="stringliteral">&quot;a+&quot;</span>);
              fwrite(preview_data, 1024, 4, fp);
              fclose(fp);

              echo_data-&gt;eof = <a name="a9"></a><a class="code" href="group__REQUEST.html#ga0b1cadb60f6d198af3a04cc13442c3cb">ci_req_hasalldata</a>(req);
          }
              <span class="keywordflow">return</span> CI_MOD_CONTINUE;
     }<span class="keywordflow">else</span> {
          whattodo = 0;
          <span class="comment">/*Nothing to do just return an allow204 (No modification) to terminate here</span>
<span class="comment">           the ICAP transaction */</span>
          ci_debug_printf(8, <span class="stringliteral">&quot;Allow 204...\n&quot;</span>);
          <span class="keywordflow">return</span> CI_MOD_ALLOW204;
     }
}

<span class="comment">/* This function will called if we returned CI_MOD_CONTINUE in  echo_check_preview_handler</span>
<span class="comment"> function, after we read all the data from the ICAP client*/</span>
<span class="keywordtype">int</span> echo_end_of_data_handler(<a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req)
{
    <span class="keyword">struct </span>echo_req_data *echo_data = ci_service_data(req);
    <span class="comment">/*mark the eof*/</span>
    echo_data-&gt;eof = 1;
    <span class="comment">/*and return CI_MOD_DONE */</span>
     <span class="keywordflow">return</span> CI_MOD_DONE;
}

<span class="comment">/* This function will called if we returned CI_MOD_CONTINUE in  echo_check_preview_handler</span>
<span class="comment">   function, when new data arrived from the ICAP client and when the ICAP client is </span>
<span class="comment">   ready to get data.</span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> echo_io(<span class="keywordtype">char</span> *wbuf, <span class="keywordtype">int</span> *wlen, <span class="keywordtype">char</span> *rbuf, <span class="keywordtype">int</span> *rlen, <span class="keywordtype">int</span> iseof,
            <a class="code" href="group__REQUEST.html#ga27da5c4ae491f527ce36901c2e78ea04" title="This is the struct which holds all the data which represent an ICAP request.">ci_request_t</a> * req)
{
     <span class="keywordtype">int</span> ret;
     <span class="keyword">struct </span>echo_req_data *echo_data = ci_service_data(req);
     ret = CI_OK;

     <span class="comment">/*write the data read from icap_client to the echo_data-&gt;body*/</span>
     <span class="keywordflow">if</span>(rlen &amp;&amp; rbuf) {
         *rlen = ci_ring_buf_write(echo_data-&gt;body, rbuf, *rlen);
         <span class="keywordflow">if</span> (*rlen &lt; 0)
            ret = CI_ERROR;
     }

     <span class="comment">/*read some data from the echo_data-&gt;body and put them to the write buffer to be send</span>
<span class="comment">      to the ICAP client*/</span>
     <span class="keywordflow">if</span> (wbuf &amp;&amp; wlen) {
          *wlen = ci_ring_buf_read(echo_data-&gt;body, wbuf, *wlen);
     }
     <span class="keywordflow">if</span>(*wlen==0 &amp;&amp; echo_data-&gt;eof==1)
         *wlen = CI_EOF;

     <span class="keywordflow">return</span> ret;
}
</pre></div> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 14 Jun 2016 for c-icap-doc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
